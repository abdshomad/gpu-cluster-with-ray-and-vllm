# Prometheus configuration for Ray cluster metrics
# This configures Prometheus to scrape metrics from Ray nodes
# 
# Ray generates a complete prometheus.yml configuration file at:
# /tmp/ray/session_latest/metrics/prometheus/prometheus.yml
# This config merges Ray's auto-generated scrape configs with our custom configuration.

global:
  scrape_interval: 15s      # How frequently to scrape targets
  evaluation_interval: 15s  # How frequently to evaluate rules
  external_labels:
    cluster: 'ray-gpu-cluster'
    monitor: 'gpu-cluster-monitor'

# Scrape configurations
scrape_configs:
  # Ray auto-discovery: Scrape from each Ray node as defined in the service_discovery.json
  # This uses file-based service discovery to automatically discover all Ray nodes (head and workers)
  # The service discovery file is generated by Ray at /tmp/ray/prom_metrics_service_discovery.json
  - job_name: 'ray'
    file_sd_configs:
      - files:
          - '/tmp/ray/prom_metrics_service_discovery.json'
        refresh_interval: 10s  # Refresh service discovery every 10 seconds
    scrape_interval: 15s
    scrape_timeout: 10s
    metrics_path: '/metrics'
    relabel_configs:
      # Add cluster label to all Ray metrics
      - target_label: 'cluster'
        replacement: 'ray-gpu-cluster'

  # Legacy: Scrape Ray head node metrics (kept for backwards compatibility)
  # Note: Ray's file_sd_configs above will also discover the head node
  - job_name: 'ray-head'
    static_configs:
      - targets: ['ray-serve:8080']
        labels:
          node_type: 'head'
          cluster: 'ray-gpu-cluster'
    metrics_path: '/metrics'
    scrape_interval: 15s
    scrape_timeout: 10s

  # Scrape Prometheus itself
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
